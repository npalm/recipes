#!/usr/bin/env node
/**
 * Generate image hash manifest at build time
 * This allows client components to access image hashes without Node.js fs module
 */

import fs from 'fs';
import path from 'path';
import crypto from 'crypto';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.join(__dirname, '..');

/**
 * Generate MD5 hash for a file
 */
function generateHash(filePath) {
  try {
    const fileBuffer = fs.readFileSync(filePath);
    const hash = crypto.createHash('md5').update(fileBuffer).digest('hex');
    return hash.substring(0, 8);
  } catch (error) {
    console.warn(`Failed to hash ${filePath}:`, error.message);
    return null;
  }
}

/**
 * Recursively find all image files in recipe directories
 */
function findRecipeImages(recipesDir) {
  const manifest = {};
  
  if (!fs.existsSync(recipesDir)) {
    console.error(`Recipes directory not found: ${recipesDir}`);
    return manifest;
  }

  const recipes = fs.readdirSync(recipesDir);
  
  for (const recipeSlug of recipes) {
    const recipePath = path.join(recipesDir, recipeSlug);
    const stats = fs.statSync(recipePath);
    
    if (!stats.isDirectory()) continue;
    
    const imagesDir = path.join(recipePath, 'images');
    
    if (!fs.existsSync(imagesDir)) continue;
    
    const images = fs.readdirSync(imagesDir);
    
    for (const imageName of images) {
      // Only process image files
      if (!/\.(jpg|jpeg|png|gif|webp)$/i.test(imageName)) continue;
      
      const imagePath = path.join(imagesDir, imageName);
      const imageStats = fs.statSync(imagePath);
      
      if (!imageStats.isFile()) continue;
      
      const hash = generateHash(imagePath);
      
      if (hash) {
        const key = `${recipeSlug}/${imageName}`;
        manifest[key] = hash;
      }
    }
  }
  
  return manifest;
}

/**
 * Main execution
 */
function main() {
  console.log('üî® Generating image hash manifest...');
  
  const recipesDir = path.join(projectRoot, 'content', 'recipes');
  const manifest = findRecipeImages(recipesDir);
  
  const imageCount = Object.keys(manifest).length;
  console.log(`‚úÖ Generated hashes for ${imageCount} images`);
  
  // Write manifest to src/lib
  const manifestPath = path.join(projectRoot, 'src', 'lib', 'image-manifest.json');
  fs.writeFileSync(manifestPath, JSON.stringify(manifest, null, 2));
  
  console.log(`üìù Manifest written to: ${manifestPath}`);
  
  // Also generate a TypeScript module for better imports
  const tsContent = `// Auto-generated by scripts/generate-image-manifest.mjs
// Do not edit this file manually

export type ImageManifest = Record<string, string>;

const imageManifest: ImageManifest = ${JSON.stringify(manifest, null, 2)};

export default imageManifest;
`;
  
  const tsPath = path.join(projectRoot, 'src', 'lib', 'image-manifest.ts');
  fs.writeFileSync(tsPath, tsContent);
  
  console.log(`üìù TypeScript module written to: ${tsPath}`);
  console.log('‚ú® Done!');
}

main();
