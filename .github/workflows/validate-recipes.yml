name: Validate Recipes

on:
  pull_request:
    paths:
      # Recipe source files
      - 'content/recipes/**/*.md'
      # Recipe validation code
      - 'src/modules/recipe/domain/schemas.ts'
      - 'tools/cli/src/commands/validate.ts'
      - 'tools/cli/src/**'
      # Build configuration that affects recipes
      - 'tools/cli/package.json'
      - 'tools/cli/tsup.config.ts'
  push:
    branches: [main]
    paths:
      - 'content/recipes/**/*.md'
      - 'src/modules/recipe/domain/schemas.ts'
      - 'tools/cli/src/**'
  workflow_dispatch:

# Concurrency: Cancel in-progress runs on new push to same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Security: Limit default permissions
permissions:
  contents: read

jobs:
  validate:
    name: Validate Recipe Markdown Files
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CLI tool
        run: npm run recipe:build

      - name: Validate all recipes
        run: npm run recipe validate content/recipes

      - name: Validate recipes with strict mode
        run: npm run recipe validate --strict content/recipes
        continue-on-error: true
        id: strict-validation

      - name: Report strict validation result
        if: steps.strict-validation.outcome == 'failure'
        run: |
          echo "⚠️ Strict validation failed (images missing)"
          echo "This is informational only and does not block the workflow"
